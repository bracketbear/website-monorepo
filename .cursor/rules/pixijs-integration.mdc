---
description:
globs:
alwaysApply: false
---
# PixiJS Integration Guidelines

## Overview
This project uses PixiJS v8 for interactive graphics and effects. Follow these guidelines to avoid common issues.

## Core Files
- **PointerFX**: Main PixiJS implementation in [packages/core/src/react/PointerFX.tsx](mdc:packages/core/src/react/PointerFX.tsx)
- **InverseBlendFilter**: Custom inverse blend mode filters in [packages/core/src/react/InverseBlendFilter.ts](mdc:packages/core/src/react/InverseBlendFilter.ts)
- **Effect Classes**: Modular effect system with SpinningRingEffect, ParticleEffect, and Particle classes

## Blend Modes & Filters
- **Difference Blend**: Default inverse-like effect using `graphics.blendMode = 'difference'`
- **Advanced Inverse Filter**: Custom shader-based inverse effect with controllable intensity
- **Custom Inverse Filter**: Complex filter for background texture sampling
- **Performance**: Difference blend is fastest, custom filters have higher GPU cost

## PixiJS v8 API Rules
- **Application Creation**: Use `new PIXI.Application()` then `await app.init(options)`
- **Canvas Access**: Use `app.canvas` instead of `app.view`
- **Event System**: Use PixiJS's built-in event system for proper coordinate handling
- **Resolution**: Set `app.renderer.resolution = 1` for consistent rendering

## Coordinate System
- **Always use PixiJS events**: `event.global.x` and `event.global.y` for accurate coordinates
- **Avoid window events**: Don't use `window.addEventListener` for mouse events
- **Canvas positioning**: Ensure canvas is properly positioned with `pointer-events-auto`
- **Container positioning**: Use `pointer-events-none` on container div

## Event Handling Pattern
```typescript
// ✅ Correct - Use PixiJS events
app.stage.eventMode = 'static';
app.stage.hitArea = app.screen;

const handlePointerMove = (event: PIXI.FederatedPointerEvent) => {
  const x = event.global.x;
  const y = event.global.y;
  // Handle coordinates
};

app.stage.on('pointermove', handlePointerMove);

// ❌ Avoid - Window events cause coordinate issues
window.addEventListener('mousemove', (e) => {
  const x = e.clientX; // Wrong coordinate system
});
```

## Effect Architecture
- **Modular Design**: Each effect should be a separate class
- **Lifecycle Management**: Implement proper destroy methods
- **Performance**: Use object pooling for frequently created objects
- **Memory Management**: Always clean up event listeners and destroy containers

## Common Issues & Solutions
1. **Effects not visible**: Check canvas pointer-events and container positioning
2. **Wrong coordinates**: Use PixiJS events instead of window events
3. **Memory leaks**: Implement proper cleanup in destroy methods
4. **Performance issues**: Limit particle count and use object pooling
5. **Vite HMR crashes**: WebGL contexts must be properly cleaned up on hot reloads

## Container Setup Pattern
```typescript
return (
  <div
    ref={containerRef}
    className="fixed inset-0 z-20 pointer-events-none"
    style={{ width: '100vw', height: '100vh' }}
  />
);
```

## Effect Class Pattern
```typescript
class MyEffect {
  private container: PIXI.Container;
  
  constructor(parent: PIXI.Container) {
    this.container = new PIXI.Container();
    parent.addChild(this.container);
  }
  
  update(): void {
    // Update logic
  }
  
  destroy(): void {
    this.container.destroy({ children: true });
  }
}
```

## Vite HMR Fix for WebGL Contexts
**CRITICAL**: PixiJS WebGL contexts don't play nicely with Vite hot module replacement. Always include this fix in React components that use PixiJS:

```typescript
// Vite HMR fix - prevent crashes during hot reloads
if (import.meta.hot) {
  import.meta.hot.dispose(() => {
    // Clean up any remaining PixiJS instances
    const canvases = document.querySelectorAll('canvas');
    canvases.forEach((canvas) => {
      if (canvas.getContext('webgl')) {
        const gl = canvas.getContext('webgl');
        if (gl) {
          gl.getExtension('WEBGL_lose_context')?.loseContext();
        }
      }
    });
  });
}
```

**Why this is needed**: Without this fix, Vite HMR will cause browser tab crashes because WebGL contexts aren't properly released when components are hot-reloaded. The `WEBGL_lose_context` extension forces the GPU to release the context, preventing crashes.

## Inverse Blend Usage
```typescript
// Simple difference blend (fastest)
graphics.blendMode = 'difference';

// Advanced inverse filter with intensity control
const inverseFilter = new AdvancedInverseBlendFilter(0.8);
graphics.filters = [inverseFilter];

// Animate intensity
app.ticker.add(() => {
  const intensity = 0.5 + 0.5 * Math.sin(Date.now() * 0.001);
  inverseFilter.setIntensity(intensity);
});

// Use in PointerFX component
<PointerFX useInverseBlend={true} inverseIntensity={0.8} />
```

## Reference Documentation
- **Full PixiJS v8 Reference**: [docs/pixijs/pixijs-v8-reference.md](mdc:docs/pixijs/pixijs-v8-reference.md)
- **Inverse Blend Examples**: [packages/core/src/react/InverseBlendExample.tsx](mdc:packages/core/src/react/InverseBlendExample.tsx)
