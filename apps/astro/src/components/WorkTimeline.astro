---
import { getCollection } from 'astro:content';
import Timeline from './Timeline.astro';
import TimelineItem from './TimelineItem.astro';
import Accordion from './Accordion.astro';
import { getKeyedCollection } from '@/utils/content';

interface Props {
  variant?: 'simple' | 'detailed';
}

const { variant = 'detailed' } = Astro.props;

const jobs = await getCollection('workJobs');
const companies = await getKeyedCollection('workCompany');
const skillsCollection = await getKeyedCollection('workSkills');

type Job = (typeof jobs)[0];
type Company = (typeof companies)[0];

// Sort jobs by start date (newest first)
const sortedJobs = jobs.sort((a, b) => {
  const aDate = new Date(a.data.startDate);
  const bDate = new Date(b.data.startDate);
  return bDate.getTime() - aDate.getTime();
});

// Group jobs by company
const jobsByCompany: Record<Company['id'], Job[]> = sortedJobs.reduce(
  (acc: Record<Company['id'], Job[]>, job: Job) => {
    const { data } = job;
    const { company: companyKey } = data;

    acc[companyKey] ||= [];

    acc[companyKey].push(job);
    return acc;
  },
  {}
);

// Sort companies by most recent job's start date
const sortedCompanies = Object.entries(jobsByCompany)
  .map(([companyKey, companyJobs]) => {
    const { [companyKey]: company } = companies;
    const mostRecentJob = companyJobs.reduce((latest, current) => {
      const latestDate = new Date(latest.data.startDate);
      const currentDate = new Date(current.data.startDate);
      return currentDate > latestDate ? current : latest;
    }, companyJobs[0]);

    return {
      company,
      jobs: companyJobs,
      mostRecentStart: new Date(mostRecentJob.data.startDate),
    };
  })
  .sort((a, b) => b.mostRecentStart.getTime() - a.mostRecentStart.getTime());

// Format job date
const formatDate = (dateString: string | undefined) => {
  if (!dateString) return 'Present';
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    year: 'numeric',
  });
};
---

<div class="space-y-16">
  <h2
    class="brutalist-border bg-cream inline-block p-6 text-4xl font-black text-black uppercase"
  >
    Work History
  </h2>

  <div class="space-y-12">
    {
      sortedCompanies.map(({ company, jobs }) => (
        <div class="brutalist-border bg-cream p-8">
          <div class="mb-8">
            <h3 class="text-2xl font-black text-black uppercase">
              {company.data.title}
            </h3>
            {company.data.description && (
              <p class="mt-2 font-bold text-black">
                {company.data.description}
              </p>
            )}
          </div>

          <div class="relative space-y-8">
            {jobs.map((job, index) => (
              <div class="relative">
                {/* Timeline connector */}
                {index < jobs.length - 1 && (
                  <div class="absolute top-12 left-[1.65rem] h-full w-0.5 bg-black" />
                )}

                <div class="flex gap-6">
                  {/* Timeline dot */}
                  <div class="brutalist-border bg-coral mt-1.5 h-8 w-8 shrink-0" />

                  <div class="flex-1">
                    <div class="mb-4">
                      <h4 class="text-xl font-black text-black uppercase">
                        {job.data.title}
                      </h4>
                      <p class="font-bold text-black">
                        {formatDate(job.data.startDate)} -{' '}
                        {formatDate(job.data.endDate)}
                      </p>
                    </div>

                    {job.data.description && (
                      <p class="mb-4 font-bold text-black">
                        {job.data.description}
                      </p>
                    )}

                    {job.data.skills && job.data.skills.length > 0 && (
                      <div class="flex flex-wrap gap-2">
                        {job.data.skills.map(
                          (skillId) =>
                            skillsCollection[skillId] !== undefined && (
                              <span class="brutalist-border-light bg-cream px-3 py-1 text-sm font-bold text-black">
                                {skillsCollection[skillId].data.title}
                              </span>
                            )
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))
    }
  </div>
</div>
