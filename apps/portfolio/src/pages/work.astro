---
import { getCollection } from 'astro:content';
import FilteredWorkHistory from '@/components/FilteredWorkHistory';
import StatsSection from '@/components/StatsSection';
import { getWorkBreadcrumbs } from '@/config/breadcrumbs';
import HeroLayout from '@/layouts/HeroLayout.astro';
import { marked } from 'marked';

// Get the work page singleton from CMS
const workPageEntries = await getCollection('portfolioWorkPage');
const workPage = workPageEntries[0]; // Singletons have only one entry

// Get all work collections for the FilteredWorkHistory component
const workProjects = await getCollection('workProject');
const workSkills = await getCollection('workSkills');
const workJobs = await getCollection('workJobs');
const workCompanies = await getCollection('workCompany');
const workSkillCategories = await getCollection('workSkillCategory');
const breadcrumbs = getWorkBreadcrumbs();

// Helper function to parse markdown content
function parseMarkdown(content: string): string {
  return marked.parse(content) as string;
}
---

<HeroLayout
  pageTitle={workPage.data.title}
  title={workPage.data.title}
  subtitle={workPage.data.subtitle}
  breadcrumbs={breadcrumbs}
  animationPreset="curious-particle-network"
  contactCTA={workPage.data.contactCTA}
>
  <!-- Introduction Section -->
  <section class="mb-40 px-6">
    <div class="container mx-auto text-center">
      <h2 class="font-heading mb-6 text-4xl tracking-tight text-white">
        {workPage.data.introduction.title}
      </h2>
    </div>
    <div class="container mx-auto mt-8">
      <div
        class="prose prose-lg prose-headings:text-white prose-p:text-white/90 text-xl leading-relaxed text-white/90"
      >
        <div set:html={parseMarkdown(workPage.data.introduction.content)} />
      </div>
    </div>
  </section>

  <!-- Stats Section (if available) -->
  {
    workPage.data.stats && workPage.data.stats.length > 0 && (
      <StatsSection stats={workPage.data.stats} client:load />
    )
  }

  <!-- Tool Description Section -->
  <div class="mb-40 px-6">
    <div class="mx-auto max-w-4xl text-center">
      <h2 class="font-heading mb-4 text-4xl tracking-tight text-white">
        {workPage.data.toolDescription.title}
      </h2>
      <div
        class="prose prose-lg prose-headings:text-white prose-p:text-white/80 mb-12 text-xl leading-relaxed text-white/80"
      >
        <div set:html={parseMarkdown(workPage.data.toolDescription.content)} />
      </div>
    </div>
  </div>

  <!-- Work History Section -->
  <div class="mb-40 px-6">
    <FilteredWorkHistory
      skills={workSkills}
      skillCategories={workSkillCategories}
      jobs={workJobs}
      projects={workProjects}
      companies={workCompanies}
      client:load
    />
  </div>
</HeroLayout>
