---
import { type Breadcrumb, Stats } from '@bracketbear/core';
import { getCollection } from 'astro:content';
import { getWorkBreadcrumbs } from '@/config/breadcrumbs';
import HeroLayout from '@/layouts/HeroLayout.astro';
import FilteredWorkHistory from '@/components/FilteredWorkHistory';
import { marked } from 'marked';

const breadcrumbs: Breadcrumb[] = getWorkBreadcrumbs();

// Get the work page singleton from CMS
const workPageEntries = await getCollection('portfolioWorkPage');
const workPage = workPageEntries[0]; // Singletons have only one entry

// Get all work collections for the FilteredWorkHistory component
const workProjects = await getCollection('workProject');
const workSkills = await getCollection('workSkills');
const workJobs = await getCollection('workJobs');
const workCompanies = await getCollection('workCompany');
const workSkillCategories = await getCollection('workSkillCategory');

// Helper function to parse markdown content
function parseMarkdown(content: string): string {
  return marked.parse(content) as string;
}
---

<HeroLayout
  pageTitle="Work History"
  title={workPage.data.title}
  subtitle={workPage.data.subtitle}
  breadcrumbs={breadcrumbs}
  animationPreset="enhanced-wave"
  contactCTA={workPage.data.contactCTA}
  metaDescription={workPage.data.metaDescription}
>
  <!-- Introduction Section -->
  <section class="px-content mb-40">
    <div class="container mx-auto text-center">
      <h2 class="font-heading mb-6 text-4xl tracking-tight text-white">
        {workPage.data.introduction.title}
      </h2>
    </div>
    <div
      class="prose-2xl mx-auto max-w-prose text-center text-white/90"
      set:html={parseMarkdown(workPage.data.introduction.content)}
    />
  </section>

  <!-- Stats Section (if available) -->
  {
    workPage.data.stats && workPage.data.stats.length > 0 && (
      <Stats stats={workPage.data.stats} className="mb-40 mx-2 md:mx-0" />
    )
  }

  <!-- Tool Description Section -->
  <div class="px-content mb-8">
    <div class="mx-auto flex max-w-4xl flex-col items-center text-center">
      <h2 class="font-heading mb-4 text-4xl tracking-tight text-white">
        {workPage.data.toolDescription.title}
      </h2>
      <div
        class="prose-xl max-w-prose text-white/80"
        set:html={parseMarkdown(workPage.data.toolDescription.content)}
      />
    </div>
  </div>

  <!-- Work History Section -->
  <div class="px-content mb-40">
    <FilteredWorkHistory
      skills={workSkills}
      skillCategories={workSkillCategories}
      jobs={workJobs}
      projects={workProjects}
      companies={workCompanies}
      client:load
    />
  </div>
</HeroLayout>
