---
import { getCollection } from 'astro:content';
import HeroLayout from '@/layouts/HeroLayout.astro';
import { ContactForm } from '@/components/ContactForm';
import { ContactIcon } from '@bracketbear/core/react';
import { marked } from 'marked';

// Get the contact page singleton from CMS
const contactPageEntries = await getCollection('portfolioContactPage');
const contactPage = contactPageEntries[0];
const contactMethods = await getCollection('portfolioContactMethods');

// Helper function to parse markdown content
function parseMarkdown(content: string): string {
  return marked.parse(content) as string;
}

// Get contact methods in the order specified by CMS
const selectedContactMethods =
  contactPage.data.contactMethods
    ?.map((methodId: string) =>
      contactMethods.find((method) => method.id === methodId)
    )
    .filter(Boolean) || [];
---

<HeroLayout
  pageTitle={contactPage.data.title}
  title={contactPage.data.title}
  subtitle={contactPage.data.subtitle}
  metaDescription={contactPage.data.metaDescription}
  hideContactForm={true}
  currentPage="contact"
  breadcrumbs={[
    {
      label: 'Home',
      href: '/',
    },
    {
      label: 'Contact',
      href: '/contact',
    },
  ]}
>
  <!-- Contact Content -->
  <div class="bg-muted w-full">
    <div class="px-content container mx-auto flex h-full items-center py-40">
      <div class="grid w-full items-center gap-12 lg:grid-cols-2">
        <!-- Left Content Section -->
        <div class="space-y-8">
          <!-- Introduction Content -->
          {
            contactPage.data.introduction && (
              <div
                class="prose prose-xl prose-headings:text-muted-foreground prose-p:text-muted-foreground/90 text-muted-foreground/90"
                set:html={parseMarkdown(contactPage.data.introduction)}
              />
            )
          }

          <!-- Contact Methods -->
          {
            selectedContactMethods.length > 0 && (
              <div class="space-y-4">
                <h2 class="font-heading text-muted-foreground text-2xl tracking-tight uppercase">
                  GET IN TOUCH
                </h2>
                <div class="space-y-3 text-lg font-medium">
                  {selectedContactMethods.map((method: any) => (
                    <a
                      href={method.data.value}
                      class="text-muted-foreground/90 hover:text-primary flex items-center gap-3 transition-colors"
                    >
                      <span class="text-2xl">
                        <ContactIcon name={method.data.icon} />
                      </span>
                      <span>{method.data.label}</span>
                    </a>
                  ))}
                </div>
              </div>
            )
          }
        </div>

        <!-- Right Contact Form Section -->
        <div class="">
          <div class="card">
            {
              contactPage.data.contactForm.title && (
                <h3 class="font-heading mb-6 text-2xl tracking-tight uppercase">
                  {contactPage.data.contactForm.title}
                </h3>
              )
            }
            {
              contactPage.data.contactForm.description && (
                <div class="text-foreground mb-6 text-lg leading-relaxed font-medium">
                  <p>{contactPage.data.contactForm.description}</p>
                </div>
              )
            }
            <ContactForm client:load />
          </div>
        </div>
      </div>
    </div>
  </div>
</HeroLayout>
