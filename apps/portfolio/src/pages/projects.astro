---
import { getCollection, type CollectionEntry } from 'astro:content';
import { getBreadcrumbs } from '@/config/breadcrumbs';
import HeroLayout from '@/layouts/HeroLayout.astro';
import ProjectCard from '@/components/ProjectCard';
import StatsSection from '@/components/StatsSection';
import { marked } from 'marked';

// Type definitions
type WorkProjectEntry = CollectionEntry<'workProject'>;

interface ProjectCategory {
  title: string;
  description: string;
  projects: string[];
}

interface CategoryWithProjects {
  category: {
    data: {
      title: string;
      description: string;
    };
  };
  projects: WorkProjectEntry[];
}

// Get the projects page singleton from CMS
const projectsPageEntries = await getCollection('portfolioProjectsPage');
const projectsPage = projectsPageEntries[0]; // Singletons have only one entry

const workProject = await getCollection('workProject');
const breadcrumbs = getBreadcrumbs({
  label: 'Projects',
  href: '/projects',
});

// Get projects by CMS-defined categories
const projectsByCategory: CategoryWithProjects[] =
  projectsPage.data.projectCategories?.map((category: ProjectCategory) => {
    const categoryProjects = workProject.filter((project: WorkProjectEntry) =>
      category.projects.includes(project.id)
    );

    return {
      category: {
        data: {
          title: category.title,
          description: category.description,
        },
      },
      projects: categoryProjects,
    };
  }) || [];

// Get skills for project cards
const workSkills = await getCollection('workSkills');

// Calculate dynamic stats
const totalProjects = workProject.length;
const featuredProjects = workProject.filter((p) => p.data.isFeatured).length;
const totalSkills = workSkills.length;

// Helper function to parse markdown content
function parseMarkdown(content: string): string {
  return marked.parse(content) as string;
}

// Prepare stats data
const statsData =
  projectsPage.data.stats?.map(
    (stat: { label: string; value: string; description?: string }) => {
      // Replace dynamic values
      let displayValue = stat.value;
      if (stat.label === 'Total Projects') {
        displayValue = totalProjects.toString();
      } else if (stat.label === 'Featured Projects') {
        displayValue = featuredProjects.toString();
      } else if (stat.label === 'Technologies') {
        displayValue = `${totalSkills}+`;
      }

      return {
        label: stat.label,
        value: displayValue,
        description: stat.description,
      };
    }
  ) || [];
---

<HeroLayout
  pageTitle={projectsPage.data.title}
  title={projectsPage.data.title}
  subtitle={projectsPage.data.subtitle}
  breadcrumbs={breadcrumbs}
  animationPreset="curious-particle-network"
  contactCTA={projectsPage.data.contactCTA}
  metaDescription={projectsPage.data.metaDescription}
>
  <!-- Introduction Section -->
  <section class="mb-40 px-4">
    <div class="container mx-auto text-center">
      <h2 class="font-heading mb-6 text-4xl tracking-tight text-white">
        {projectsPage.data.introduction.title}
      </h2>
    </div>
    <div class="container mx-auto mt-8">
      <div
        class="prose-2xl mx-auto max-w-prose text-center text-white/90"
        set:html={parseMarkdown(projectsPage.data.introduction.content)}
      />
    </div>
  </section>

  <!-- Stats Section -->
  {statsData.length > 0 && <StatsSection stats={statsData} />}

  <!-- Projects by Category Section -->
  <div class="mb-40 px-4">
    <div class="container mx-auto">
      <div class="space-y-16">
        {
          projectsByCategory.map(
            ({ category, projects }: CategoryWithProjects) => (
              <section>
                {/* Section Title */}
                <div class="py-12">
                  <h2 class="font-heading inline-block text-4xl font-black tracking-tight text-white uppercase">
                    {category.data.title}
                  </h2>
                  {category.data.description && (
                    <p class="prose-lg mt-4 max-w-prose text-white/70">
                      {category.data.description}
                    </p>
                  )}
                </div>

                <div class="grid gap-8 lg:grid-cols-2 xl:grid-cols-3">
                  {projects.map((project: WorkProjectEntry) => (
                    <ProjectCard
                      project={project}
                      skills={workSkills}
                      variant="light"
                      showImage={true}
                      showBadges={false}
                      showSkills={true}
                      maxSkills={5}
                      compact={true}
                    />
                  ))}
                </div>
              </section>
            )
          )
        }
      </div>
    </div>
  </div>
</HeroLayout>
